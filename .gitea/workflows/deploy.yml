# 工作流的名称
name: Build and Deploy Full Stack Project

# 触发条件：当有代码 push 到 master 分支时触发
on:
  push:
    branches:
      - master

# 任务列表
jobs:
  build-and-deploy:
    # 运行环境标签
    runs-on: windows-iis

    # 环境变量
    env:
      FRONTEND_DIR: ./opsboard-frontend
      BACKEND_DIR: ./opsboard-backend
      DEPLOY_DIR: C:\inetpub\wwwroot\opsboard-web

    # 任务包含的步骤
    steps:
      # 第1步：检出代码
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ------------------- 后端构建部分 -------------------
      # 第2步：设置 Go 环境
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25' # 保持 go-version，让 action 确保版本一致性
          cache: true # 启用 Go 模块缓存

      # 第3步：下载 Go 依赖项 [核心修复]
      - name: Install Go Dependencies
        working-directory: ${{ env.BACKEND_DIR }}
        run: go mod tidy

      # 第4步：构建 Go 后端应用
      - name: Build Go Backend
        working-directory: ${{ env.BACKEND_DIR }}
        run: go build -o opsboard-backend.exe .

      # ------------------- 前端构建部分 -------------------
      # 第5步：设置 Node.js 环境
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: '${{ env.FRONTEND_DIR }}/package-lock.json'

      # 第6步：安装前端依赖并执行构建
      - name: Install Dependencies and Build Frontend
        working-directory: ${{ env.FRONTEND_DIR }}
        run: |
          npm install
          npm run build

      # ------------------- 部署部分 -------------------
      # 第7步：部署所有构建产物到 IIS 目录
      - name: Deploy to IIS Directory
        shell: powershell
        run: |
          Write-Host "Preparing deployment to ${{ env.DEPLOY_DIR }}..."
          if (-not (Test-Path "${{ env.DEPLOY_DIR }}")) {
            New-Item -ItemType Directory -Force -Path "${{ env.DEPLOY_DIR }}"
          }
          
          # 先停止服务，以便可以安全地替换文件
          $serviceName = "opsboard-backend-service"
          if (Get-Service $serviceName -ErrorAction SilentlyContinue) {
            Write-Host "Stopping service '$serviceName'..."
            Stop-Service -Name $serviceName -Force
          }

          Write-Host "Clearing destination directory..."
          Get-ChildItem -Path "${{ env.DEPLOY_DIR }}" -Exclude "stdout.log", "stderr.log" | Remove-Item -Recurse -Force
          
          Write-Host "Copying frontend build artifacts..."
          Copy-Item -Path "${{ env.FRONTEND_DIR }}\dist\*" -Destination "${{ env.DEPLOY_DIR }}" -Recurse -Force
          
          Write-Host "Copying backend executable..."
          Copy-Item -Path "${{ env.BACKEND_DIR }}\opsboard-backend.exe" -Destination "${{ env.DEPLOY_DIR }}" -Force
          
          Write-Host "Copying backend configuration..."
          Copy-Item -Path "${{ env.BACKEND_DIR }}\.env" -Destination "${{ env.DEPLOY_DIR }}" -Force
          
          Write-Host "Copying web.config..."
          Copy-Item -Path ".\web.config" -Destination "${{ env.DEPLOY_DIR }}" -Force
          
          Write-Host "Deployment successful!"

      # 第8步：使用 NSSM 创建或启动 Go 后端服务
      - name: Create or Start Go Backend Service with NSSM
        if: always()
        shell: powershell
        run: |
          $serviceName = "opsboard-backend-service"
          if (-not (Get-Command nssm -ErrorAction SilentlyContinue)) {
            Write-Error "NSSM is not found in PATH. Please install it on the runner server."
            exit 1
          }

          if (-not (Get-Service $serviceName -ErrorAction SilentlyContinue)) {
            Write-Host "Service '$serviceName' not found. Creating it..."
            nssm install $serviceName "${{ env.DEPLOY_DIR }}\opsboard-backend.exe"
            nssm set $serviceName AppDirectory "${{ env.DEPLOY_DIR }}"
            nssm set $serviceName AppStdout "${{ env.DEPLOY_DIR }}\stdout.log"
            nssm set $serviceName AppStderr "${{ env.DEPLOY_DIR }}\stderr.log"
            nssm set $serviceName Start SERVICE_AUTO_START
          }
          
          Write-Host "Starting service '$serviceName'..."
          Start-Service -Name $serviceName
          
          Write-Host "Service '$serviceName' is running."