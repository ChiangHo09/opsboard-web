# .gitea/workflows/deploy.yml (最终修复版)
name: Build and Deploy Frontend Project

on:
  push:
    branches:
      - master

jobs:
  build-and-deploy:
    runs-on: windows-iis

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'opsboard-frontend/package-lock.json'

      - name: Install Dependencies and Build
        working-directory: ./opsboard-frontend
        run: |
          npm install
          npm run build

      # 第4步：部署到 IIS 网站目录
      - name: Deploy to IIS Directory
        shell: powershell
        run: |
          $sourceBuildPath = ".\opsboard-frontend\dist"
          $sourceConfigPath = ".\web.config" # <-- 新增：指向根目录的 web.config
          $destinationPath = "C:\inetpub\wwwroot\opsboard-web"
          
          Write-Host "Checking destination path: $destinationPath"
          if (-not (Test-Path $destinationPath)) {
            Write-Host "Destination directory does not exist. Creating it..."
            New-Item -ItemType Directory -Force -Path $destinationPath
          }
          
          Write-Host "Clearing destination directory..."
          Remove-Item -Recurse -Force -Path "$destinationPath\*"
          
          Write-Host "Copying build artifacts from $sourceBuildPath..."
          Copy-Item -Path "$sourceBuildPath\*" -Destination $destinationPath -Recurse -Force
          
          # [核心修复] 新增一步：明确地将 web.config 复制到部署目录的根部
          Write-Host "Copying web.config from $sourceConfigPath..."
          Copy-Item -Path $sourceConfigPath -Destination $destinationPath -Force
          
          Write-Host "Deployment successful!"